import zstd
import hexdump
from sshx_pb2 import SerializedSession, SerializedShell  # 从生成的 protobuf 文件中导入

# 解压并解析十六进制数据


def restore_from_hex(hex_data: str):
    # 将十六进制字符串转换为字节数据
    compressed_data = bytes.fromhex(hex_data)

    decompressed_data = zstd.decompress(compressed_data)

    # 解析为 SerializedSession 对象
    session = SerializedSession()
    session.ParseFromString(decompressed_data)

    # 打印解析后的数据
    print("还原后的会话信息：")
    print(f"加密零值: {session.encrypted_zeros.hex()}")
    print(f"名称: {session.name}")
    print(f"写密码哈希: {session.write_password_hash.hex()}")
    print(f"下一个 SID: {session.next_sid}")
    print(f"下一个 UID: {session.next_uid}")

    # 打印每个 shell 的信息
    for sid, shell in session.shells.items():
        print(f"\nShell ID: {sid}")
        print(f"序列号: {shell.seqnum}")
        print(f"数据长度: {len(shell.data)} 字节")
        print(f"块偏移: {shell.chunk_offset}")
        print(f"字节偏移: {shell.byte_offset}")
        print(f"是否关闭: {shell.closed}")
        print(
            f"窗口大小: {shell.winsize_x}x{shell.winsize_y} ({shell.winsize_rows} 行 x {shell.winsize_cols} 列)")


# 示例调用
if __name__ == "__main__":
    # 示例输入（替换为你的实际十六进制数据）
    hex_data = "28b52ffd60fa0fd187000a1057c23b95e820aa7e89b41317cc2a590612c321080112be2108cc1f1268ca2c32c479c6df12cd887c1b7d4b5aa374ed777ceb634b1f6c46bdc34a727699a44bf7a793b3ab9125a73690bec641705ffe82c1afb71de3e460a27ee99985960e6b9bddb5cfaa001d4eb99f03c718a95246be836eaab7bf7dab027d26b93685c165785b458c1742122bf40566d3d4bf11b04dc86246743a4e3f322cedfbecdac2289b8114837f023fa3eff407ab71f1aa7ca04b41120eb0a7dc7564f197befdf3ba69ed55123d72253e5d2d9bf25af527f3930287e4512df3125026d87b3ef6f2e642a53404e332f55e1083b0b21d77cc8445d40ccd9b60ea33a977edb03a6abb3c342f129201e2db1a8d4653693ec3a527959a866471fddd229dd5112fb730894cbbdd89895933524c6afd2dea7fe145826e547a053f0c37ef10d65e81a07e30f143233cf24b32edbaf42af37f6517f8aef8cf805b52bd29953499ef94b5684ff4bcfc6d159afae5d005613b9e0827c0d1e7fc5a9a80cb73741056829f9584295674e5bb86349809ffaa25ebbcc355e5ad7ba482f0f537be120749c76f491ebd781208dbf39a0c92809d2b1201ba1214fee3cb29e1c36652655dc6d351ef6a0867321ba212ae0152aa8846ef65de51f6508888441d22ff0a911df03403fd203c1a34ba8a8bb4d4d033dfb926da02f9b5b321611e4f9f829c95893c75b21e4d183e281d9a7a2019f1cf50f8e26549be9ce3e7581010265438b47264b1c83f55551a4ccd98d330b34694ce347f03e249615abdfc2fe9c5c4e1097d094f5364a048f399a72feeda58c6f450a4a9327867230809d6d987294fa16dc00d1fc0fe36ce08c2bc2e39931777a7635be6694772a1082ff4169412307ce25e33fcc1e2f90642e6834ef6aedabb4461638f664cc73cba934610a1cd5c0e79a8c592cf146c523361308fe28b9e121bb5f32c4f885a6310590943aa237293a20b17bf78ceb503ff92c5ca121b76d7be6383ed71258c165b2d3691afe5e05aa4c9dfad302b4727141219a6e831acb785fe749ca2bdbc3dbd1603b2442bad1b6326f0a1121a5baf03bd01bed01c41a67821e7f8ad51f7aa3306b2a73316cc4712470c3640c4187a0607b03ae5a379eab35d939eb35ee01140e58d2e7338ccf0979ccc168553f05e627399eb886c79f2b3d29571327eaf1108660142e19de5d45a51f77fdf175bb8f0120b93308599b7cef589bf0cad12106cb9a4d23a0250864fdcc659ee8e01ff12157460f415bb95bb9f1a18f3f00f2dbc720a9e1111531215dcecadc895aca4d253df358867d660ad6bb8d34d7512159849467f9e2bd820f823cfe422319bd006dc8ae539120793ee2fcd84b0a512083f94b75b07c7ce01120513e69726cb12131ae05c668b9aea3b1c2f9b05f8623f88a1282c126829a82b7b011a7539e878bbfc1394ad90d00a46a0652ff83f8b838ae70ec7947ac34ce60e17277b39d3e64c971c12fcf05dbd2088bd56759c1cf92f9d1ef33b8549a0dab3eaee2afd714da4a3cafc0ce9e454615929531a7637ad5bcbde154ac0b605c61277ef70551243807f0fd689b10df4a3406b110b1cf3b541ccdb54e18c9be8f7bf29753751631400918312b0fac2a7fe3e17a338d774d10d0dce2a4f7293dd06aa7383db5c08221a226e12428ace01a50c547cdb54a16d9503d35e1da9b8da121d2ace6f2694a5410c0a22ecb47a1b4b24ee18025f1788971d8e0539fd03d14737990d4f4359fa81b354fe772aad129401bc987d15e37709195e9a5d4c7aacffdc99e87167cd048f07fe501873894033fade93fd3fe690e35589ad191cf61930ae3469c99e9eaddde3c7b3c77aa70df05abc390186eba45fe72b0188188c719e34c15661af385f5ee3d651939898a1e745dc4484c4fdc637217dbc7ed8dd49b0ad8901f00fd57cf182236f58a58b1ee8d3cd38bdb84a43da2056e688ed417712a7a1df0d041203957dfe12079a5d5f285653e01208965b31c1cdae032a120120120c8b81596cec473bd604c3186a121a9fb8f80384a301188fd784ee0bc0963636341e1219ffbfc12c011212ed0eaf29fd89247abb9c32c6bce65677b0e5120787ba58455b4a96120739d7bd9030c5141208e26cc91086d98ca212033ca0b8120a70998fc3e7c63babe2ee120779290ee1a9e9de120aca7ab4b50b42bab90e2c12688554f733aa90a10e60332e13b84bd2782b3ebe077a49dc6f81f6dd17a4721f0a23cdd3f2028ecc86a617b7f2e1e29a66beaa73da730d6532b622e0f0d85115bbb4010ba53c2ae9115d278f5053959cccbae54486d1fadba8d08074edd6cd541e94d317adf7ba247312436a21a727456f9be3990c9f2e7cab2dbc10185ec4e5e44a45c6255d6d03ffb09df5aca80045812cfff52e6955e53a91c11438c4f767591b617ecedcc59c2f8c25adaf1912424e127a7b11b13e57972b2278a0b12c910ed5ffba746afaccfa69bd949f0a09aab9725e0133b5e3b74668aea7943f2d62ba307c0e4fc66da1efdc32d65bfe05efc8f4129401ee99cc36fb0196d44c91bee36aa9ebd479686ca622641e4ff2b0daceeeb7b1dc3f123cccf9b7b4e231c68ec6f9fbbdc39379dacb4aa6ffce46af3b2a280cfc3c121ede2e148e9d03b0db960be4fb851029f09b6e5658516560a775888133a234a4f4805b9cb772f1ae2ea3b5f3a768e37131916f6976a52a2bb93f648dc9fa82a1a838a04f83ca3f40fdaa1b36f567b457fb049a12030c84ae1207390a9a5da58d141208b0a33ee432b70cd7120101120c12777218b01718661a5aa1f8122033cade98707d67a10d63f72b22608dd9079479f56600b266abb361925c0ef2ee1212ba4f016a0e841c218d07116d80826efe9bef121f6537d5230b52cee385f41bf997e8961219cd8ffc5e4b67521131f7d1899997122970435fe32458e21453d8ff1c5a766a1e1071ba0c694937885b1d0415b84efefb5dee77f873dbb752a0122635dc24900198a72a738201f1097966e401f7740e918004414e056c258490ccd440acae79853b121204ebe50754c67a21bfcb487b69549a26e0bb1235c61e5fc6beb419086a290204780d7c22c3e36b4def890a6836839a62bda6b1c125fc36c95a4ab6e249b75fe46674607b3615e993e0121e8f437efb1b69f14028c500078cdb5cb4c396c2278d968fb6817f4c79a92c121edf804f043c24f9d005d04ed6e668611c05313616aa90b0ff861cba7f6a35124747a9e22c8d8095ab2f91023ec1657e39333a73725a967a6624a3f79a355d1a3408551e8636cd6c3f54ad073e0a3c34b8820718b8f24b558722d493a187ed8bdef3493ab0c3d4aa1207084b59020b5164120831cfe1b012ab225f120306a8211216b3aae6e206e3027ab9caec143e3c622ef36f98b957d11209e8b6ae48e4ef131ff21268ebbff3231e61e8bc3b350905430d5aae0cddeb0b9496beab5c8ed3fefecd014e3118462ac12c59c17fcccc81fbe5c723ecbac5ac01b945f94751e31ff9f10b3ae84e4022ab1cdc181f17e7c1b65970bcd498bad1307073e1007cc066bbfa5a9e593d9d631d30006b123001906e7150d67dec6ed1f8830813c2295b93bb70cd224de35ad4a2da7ff9011b65d717330497f727f528c632d2f79c1b1213f6d8cb3d7f5e8bf97f2206db89eacbdb013d5a12421a5ff84071a72f3334d358d3d1681e34f121ca974cb4554a76647127422212d497fffb77d69e6beecf920ae1a3d723d30827167f73fd50e5f85c3b5d78f6a67f8db0129701294655b75ae713564e02fadf72bba54a51c83b5eb07651af566b300942c73f2eed3be8f145fc37f077afbad7ec8ed9d781a88f212a4f13bf332a45c7f84a56f9af736258ab9c66a0539d3b0320d4e3adb5ba6bdd4e8cb0ad17fe0b26654fcff96ede74c38741810496a80ca63bb85e2617c83bb030589d7847cdd9f2ad8b41b5833f755688c088143ea7d3e819d95837fb6799d0fadb53120751a512feea3a211208761039f8680c527f1201311214a9acc9ad6a6054b047cfa825a7b9fbd13b843c66122ac00887db14d7e2cbdc1bc4bd4f9f0ed4e4492e1da776b328a4687d8ccfc9ba145323d9df49bd55aae76e124156f8ffc8fd7329366deba56ef3e3c8fff1cb4234ea3d665bf1a2c2bf112c885ffccc3a96887988a88cc44b57c38cfbfc18235852d2ec0ca9a49088e426228d17bf1299018e99e3cf30e84aeab305acc41dcdf40c6a5f749f193845c77528313f91628990ad1f27335112f5c899eedd215e129049f319f19a8f83dc7050c7f8ac5133f0702e13eb35186179eea9b852cd0b367444defd22a511692aa38552b44e655ad9de54f9109191d2f2e6ef83bf884b325e37e939612a9e21b8c200c6e1e5ac90e7513811644a581e8925614a256166c3d54a62a858b8bd1721d832123b66132f4d2769a7e51d1b559f3a778a186fbb64728d0748c4ac0234cec4ac8f322d67b7258b3f33b74d7f1a5881bc8d2161fdf2bcdaa12dfadfa15312265965d9d2d0e26b30605b6639b416fe5279173c4efbafb1bcb38e1cb36f6b7e8cded0b513a9d81217d82fd58573f760059da9b16a385b31c51997d39b633ba2121290746fa9b02c514e9c8b5fdab777adb3dc2b1213348b47ca0239ab80cf765628ab42978420848f1206ba449ec2e0f2120b07177e3f9eacb57815317612155e36a91072e03c168bb7e80c0e01ced9a07b955b4412506fb8cfa0bd5ad1ae2bb4e36f06c4d8eee771d3c5d8c38c9bd3f299d6739fd8ce032923b811a449038acd3c1b70b12afd39c830832c884cd7d07c0d37e31a7d6f9339b2596918e7d4a5d8bfa8d896a8471207158e23384009a01207a63c4fb5de6cc8120895a6e118ce32ec0e1205cfed11cbcd121943c57149d541c2cf05d9e19c87bc37f2cabc66f85174a17c4412401d58dd5c0883058aaf50acc57d595be9f2c2d821fabdf7c0c6a66b3658806075e55d3e2669d38632a0284a6afec2a0ecb5d1ef4d863c778985763a758752515312688e2a77aed59fc82b9539c5ab4b511b33b5ad0ca94df55baeb62aa68f9601e231e7facd961f01289b93c71f9acd752c66f130593dfb05fac7195815766eeb63f67b9150605051d93184073d9226a788d56c8eeb2d66190942a7bf145195056de465e26a2f0478abe112434e7f3e133123d9ccaaeeb1010aa0be5c32fee7323ac2d48b3e43e7bd940e11e760f85360cf50b8bf7bccc6f8d8aaf9facc1a9abe897bf0a0b66c3e6036881f2ef31a4e124292535d9839177bce4ad3a308a3d7bbb8299e48d193153e0b09bd6b22f6bdb4b50062b8296c375658ff094613e027f474f248254ac43268b32c5b3bce183a60db3a5a129401f8a0ee204ab18ded98495dec2a49d9f1556f1bda54aef9ced321db6a3b306cd74a737399c2db4b40960fef4477f84105032f27e58cdea9e927da766057414a5776708f8a93447c1e770240a40759a9bba984a97e3da1087b44f421c61c63265961d75e7b44ce24a06bc72abb28128b5afc66f5970925eaa180071d6eb0ad38ba745c683cddad8ba64bd3ca036adc46bd64ff1fcc1203019109120fa5adfa9ab603bdd32c0c81e44e61321201ba1214e2a082bfbce0721d45a50bfff93ecfe2e25a786a1224b19f48f19b0d93604f8f194cb4915de8b532f8eedaca32a370d4984dae8f6af6b39fdcb1121e3ff6bc7a66a5ee52bd9678fe560c6e81920c0998ca994343fcce798ea30f121b2565d4a6ac997f1b87be97655d74394a5b239cf31de086be9dccaf12193c96fe9660d9494396c4c3e9e6b3c76570a2303b8879218e3a122a66b2fffc380cadc2130699e99919e8e1993f221fc1df21613f2f49e95fe617d98f8ccb6b5b5be9ceb915121ea9019dd04ee90448c5d965d664401b478ee703c0ac97188cbf9ee5652a4c12318bf8f209b2f994fd597104135e57846b535e28cbd2087f8a8efc946b615650f922a55811df3a300dcea83f847875097b4112074da477d201d94012089959b8ea5ba79c7212037c7e531212eee295e8b3f767273cd0f9199efe8cfb2b53280140184850180220022a1c7a7973676d7a62407a7973676d7a6264654d6163426f6f6b2d50726f"

    # 调用还原函数
    restore_from_hex(hex_data)
